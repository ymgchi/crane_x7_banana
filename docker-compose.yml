volumes:
  gazebo_fuel_cache:  # Gazeboモデルキャッシュ（再ダウンロード防止）

services:
  ros2_builder:
    profiles:
      - sim
      - real
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    volumes:
      - type: bind
        source: "."
        target: "/workspace"
    command: /workspace/ros2/scripts/docker/build-entrypoint.sh

  crane_x7_ros2_real:
    container_name: ros-dev-banana
    profiles:
      - real
    env_file: .env
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    volumes:
      - type: bind
        source: "."
        target: "/workspace"
      - type: bind
        source: "/tmp/.X11-unix"
        target: "/tmp/.X11-unix"
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      ros2_builder:
        condition: service_completed_successfully
    entrypoint: ["/workspace/ros2/scripts/docker/entrypoint.sh"]
    command: bash -c "ros2 launch crane_x7_examples demo.launch.py port_name:=/dev/ttyUSB0"

  crane_x7_ros2_sim:
    container_name: ros-dev-banana
    profiles:
      - sim
    env_file: .env
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - __GLX_VENDOR_LIBRARY_NAME=nvidia
      - __NV_PRIME_RENDER_OFFLOAD=1
      - __VK_LAYER_NV_optimus=NVIDIA_only
      - VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
      - SIMULATION_MODE=true
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    volumes:
      - type: bind
        source: "."
        target: "/workspace"
      - type: bind
        source: "/tmp/.X11-unix"
        target: "/tmp/.X11-unix"
      - type: bind
        source: "/dev/dri"
        target: "/dev/dri"
      - gazebo_fuel_cache:/root/.gz/fuel  # Gazeboモデルキャッシュ
    devices:
      - /dev/dri/card1:/dev/dri/card1
      - /dev/dri/card2:/dev/dri/card2
      - /dev/dri/renderD128:/dev/dri/renderD128
      - /dev/dri/renderD129:/dev/dri/renderD129
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      ros2_builder:
        condition: service_completed_successfully
    entrypoint: ["/workspace/ros2/scripts/docker/entrypoint.sh"]
    command: bash -c "ros2 launch crane_x7_gazebo crane_x7_with_table.launch.py use_sim_time:=true"

