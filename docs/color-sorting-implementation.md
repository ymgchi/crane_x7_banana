# 色分別キューブ仕分けデモの実装

このドキュメントでは、点群ベースの色分別デモ `point_cloud_sorting` の実装について解説します。

## アーキテクチャ

C++/Python分離アーキテクチャを採用:
- **Python**: メインロジック、色検出、エッジ検出
- **C++**: MoveItラッパー（ROS 2サービス）

```
┌─────────────────────────────────────────────────────────────┐
│                    Python Node                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  ColorDetector  │  │ EdgeGraspFinder │  │RobotController│ │
│  │  (RGB→HSV検出)  │  │ (点群エッジ)    │  │(サービス呼出) │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└───────────────────────────────┬─────────────────────────────┘
                                │ ROS 2 Services
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                  C++ Motion Service Node                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              MoveGroupInterface (MoveIt)                 │ │
│  │  - /motion/move_to_camera_pose                          │ │
│  │  - /motion/open_gripper / close_gripper                 │ │
│  │  - /motion/execute_pose / execute_cartesian             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## プログラム構成

```
crane_x7_examples/
├── scripts/
│   ├── point_cloud_sorting_node.py       # メインノード
│   └── point_cloud_sorting/              # Pythonモジュール
│       ├── __init__.py                   # パッケージ初期化
│       ├── color_detector.py             # RGB画像からHSV色検出
│       ├── edge_grasp_finder.py          # 点群エッジ検出
│       └── robot_controller.py           # ロボット制御
├── src/
│   └── motion_service_node.cpp           # MoveItサービスノード（C++）
└── launch/
    └── point_cloud_sorting.launch.py     # 起動ファイル
```

## 検出システム

### 色検出（ColorDetector）

RGB画像をHSV色空間に変換して色検出を行います。

**検出色とHSV範囲:**

| 色 | H (色相) | S (彩度) | V (明度) | 配置場所 |
|---|---|---|---|---|
| **青** | 100-125 | 100-255 | 30-255 | 右奥 (0.30, -0.30) |
| **黄** | 20-35 | 100-255 | 60-255 | 左奥 (0.30, 0.30) |
| **緑** | 40-80 | 100-255 | 30-255 | 前方 (0.45, 0.00) |

**処理フロー:**

1. RGB画像をHSVに変換
2. `cv2.inRange()` で各色のマスク生成
3. モルフォロジー変換でノイズ除去
4. 輪郭検出で物体位置を特定
5. 深度画像から3D座標を計算
6. TF2でbase_link座標系に変換

### エッジ検出（EdgeGraspFinder）

点群データからエッジを検出し、最適な把持点を推定します。

**処理フロー:**

1. 点群をOpen3Dフォーマットに変換
2. Voxelダウンサンプリング（5mm）
3. 曲率計算でエッジポイント抽出
4. GaussianMixtureでクラスタリング
5. 最適な把持点を選択

## 動作フロー

### フェーズ0: キューブスポーン

- 5個のキューブを作業エリア内の固定位置にスポーン
- 各キューブにランダムで青/黄/緑のいずれかを割り当て

### フェーズ1: スキャン

1. カメラ観察姿勢へ移動
2. RGB画像から全キューブを検出
3. 作業エリア内のキューブをリスト化

### フェーズ2: ピック＆プレース

各キューブに対して:

1. **ホバー**: 目標上空（0.20m）へ移動
2. **グリッパー開**: 把持準備
3. **下降**: ピック位置へ（動的高さ調整）
4. **安定待機**: 0.85秒（アーム振動収束）
5. **グリッパー閉**: キューブを把持
6. **上昇**: 0.30m（衝突回避）
7. **移動**: 色に対応した配置場所へ
8. **グリッパー開**: キューブを解放
9. **復帰**: カメラ姿勢に戻る

### 終了条件

最大10イテレーション、または全キューブ処理完了

## RViz可視化

以下のトピックで検出結果を確認:

| トピック | 内容 |
|---------|------|
| `/edge_detection/region_points` | フィルタリング後の点群（緑色） |
| `/edge_detection/edge_points` | エッジポイント（赤色） |
| `/edge_detection/grasp_marker` | 把持候補マーカー（球体） |

## パラメータ設定

### 検出パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| 深度オフセット | 0.015m | カメラ測定値補正 |
| 深度範囲 | 0.15-1.2m | 有効検出範囲 |
| 面積閾値 | 1000px | ノイズ除外 |
| 重複閾値 | 0.04m | 同一物体判定 |

### モーションパラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| ホバー高さ | 0.20m | アプローチ高さ |
| 持ち上げ高さ | 0.30m | 衝突回避 |
| 安定待機時間 | 0.85秒 | 把持前待機 |
| グリッパー開 | 60° | 開放状態 |
| グリッパー閉 | 20° | 把持状態 |

### MoveIt設定

| パラメータ | 値 |
|-----------|-----|
| 速度スケール | 0.7 |
| 加速度スケール | 0.7 |
| プランニング時間 | 20秒 |

## ROS 2サービス

| サービス | 説明 |
|---------|------|
| `/motion/move_to_camera_pose` | カメラ姿勢へ移動 |
| `/motion/open_gripper` | グリッパーを開く |
| `/motion/close_gripper` | グリッパーを閉じる |
| `/motion/execute_pose` | 目標姿勢へ移動 |
| `/motion/execute_cartesian` | デカルト空間で移動 |

目標姿勢は `/motion/target_pose` トピックで事前設定します。

## トラブルシューティング

### キューブが検出されない

1. HSV範囲が環境照明に合っているか確認
2. 深度画像の取得を確認: `ros2 topic echo /camera/aligned_depth_to_color/image_raw`
3. TFフレームを確認: `ros2 run tf2_tools view_frames`

### ピック位置がずれる

1. 深度オフセット値を調整
2. カメラキャリブレーションを確認
3. TF変換が正しく行われているか確認

### グリッパーで掴めない

1. ピック高さを調整（`pick_z_above`）
2. 安定待機時間を延長（`stabilize_wait`）
3. グリッパー閉じ角度を調整

---

## 関連ドキュメント

- [実行方法](usage.md) - デモの実行手順
- [開発ガイド](development.md) - 新しいプログラムの追加方法
- [座標変換](coordinate-transformation.md) - TF2による座標変換の詳細
